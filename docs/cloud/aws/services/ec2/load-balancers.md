<script setup>
import { loadBalancerDiagram } from './diagrams.ts'
</script>

# Elastic Load Balancers (ELB)

Load Balances are servers that forward traffic to multiple servers (e.g. EC2 instances) downstream.

::: details Diagram
<vue-mermaid-string :value="loadBalancerDiagram" />
:::

## Types

### 1. CLB v1 (Classic Load Balancer) (Deprecated)

- Supports TCP (Layer 4), HTTP & HTTPS (Layer 7)
- Health checks are TCP or HTTP based
- Fixed hostname XXX.region.elb.amazonaws.com

### 2. ALB v2 (Application Load Balancer)

- Application load balancers is **Layer 7** (HTTP)
- **Supports**:
  - **HTTP/2** and **WebSocket**
  - **redirects** (e.g. from HTTP to HTTPS)
- **Routing tables to different target groups**:
  - Routing **based on path** in URL
  - Routing **based on hostname** in URL
  - Routing **based on Query** String, Headers
- **Target Groups**:
  - **EC2 instances** (can be managed by an Auto Scaling Group): HTTP
  - **ECS tasks** (managed by ECS itself): HTTP
  - **Lambda functions**: HTTP request is translated into a JSON event
  - **IP Addresses**: must be private IPs
- ALB **can route to multiple target groups**
- **Health checks** are at the **target group level**

### 3. NLB v2 (Network Load Balancer)

- NLB operates at **Layer 4** and allows to forward TCP and UDP traffic to EC2 instances
- High performance, handling millions of request per seconds with Ultra-low latency
- Has one static IP per AZ
- **Supports**:
  - Elastic IP assignment
- **Target Groups**:
  - **EC2 Instances**
  - **IP Addresses** (must be private IPs)
  - **ALB** (Application Load Balancer)
- **Health Checks** support the **TCP, HTTP and HTTPS Protocols**

### 4. GLB (Gateway Load Balancer)

- GLB operates at **Layer 3**
- **Deploy**, **scale**, and **manage** a **fleet of 3rd party network virtual appliances in AWS** (e.g. Firewalls, Intrusion Detection and Prevention Systems, Deep Packet Inspection Systems, payload manipulation, …)
- Combines the following functions:
  - **Transparent Network Gateway**: single entry/exit for all traffic
  - **Load Balancer**: distributes traffic to your virtual appliances
- **Uses the GENEVE protocol** on **port 6081**
- **Target Groups**:
  - **EC2 Instances**
  - **IP Addresses** (must be private IPs)

## Sticky Session (Session Affinity)

Allows to implement stickiness so that the same client is always redirected to the same instance behind a load balancer

- **Allowed Load Balancer Types**
  - **CLB** (Classic Load Balancer)
  - **ALB** (Application Load Balancer)
  - **NLB** (Network Load Balancer)
- To allow stickiness, **a cookie is set to the client**:
  - **Cookie Types**
    - **Application-based Cookies**
      - **Custom cookie**:
        - Generated by the target
        - Can include any custom attributes required by the application
        - Cookie name must be specified individually for each target group (AWSALB, AWSALBAPP, or AWSALBTG names are reserved by the ELB)
      - **Application cookie**:
        - Generated by the load balancer
        - Cookie name is AWSALBAPP
    - **Duration-based Cookies**
      - Cookie generated by the load balancer
      - Cookie name is AWSALB for ALB, AWSELB for CLB
- **Limitations**:
  - **may bring imbalance** to the load over the EC2 Instances

## Cross Zone Load Balancing

Allows a load balancer instance to distribute evenly across all registered instances in all AZ if enbled.

::: details Cross Zone Load Balancing differs from one load balancer type to another
| Load Balancer Type        | Default  | Charges for inter AZ data |
|---------------------------|----------|---------------------------|
| Application Load Balancer | Enabled  | Free                      |
| Network Load Balancer     | Disabled | Yes                       |
| Gateway Load Balancer     | Disabled | Yes                       |
:::

## Deregistration Delay

Deregistration Delay is **the time an ELB waits before removing a target after it's deregistered**.

During this period, the instance finishes ongoing requests but receives no new ones. This helps avoid service disruption.

The default delay is 300 seconds, but it can be adjusted based on the application’s needs (0 means disabled).
